<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title></title>
</head>

<body>
	<script>
		"use strict";

		class UserStorage {

			// 유저가 등록되었는지 확인
			async searchUser(userName, password) {

				// await: 프라미스 객체가 반환될 때까지 다음 코드의 동작을 중지하고,
				// 				프라미스 객체의 fulfilled 값을 반환한다.
				//        await는 async 함수 안에서만 사용할 수 있다.
				return await new Promise((resolve, reject) => {
					fetch("users.json")
						.then((data) => {
							// Response.ok
							// HTTP 상태 코드가 200~299일 경우
							if (data.ok) {
								return data.json();
							} else {
								console.log(new Error("네트워크 응답에 문제가 발생했습니다."));
							}
						}).then((res) => {
							const result = res.user.find((item) => {
								return item.userName === userName && item.password === password
							});


							if (result) {
								// await로 인해 Promise 객체가 아닌 userName이 반환된다.
								resolve(userName);
							} else {
								throw new Error("user not found");
							}
						})
				})

			}

			// 등록된 유저에 따른 인사말을 출력
			async sayHi(user) {

				return await new Promise((resolve, reject) => {

					fetch('greetings.json')
						.then((data) => {
							if (data.ok) {
								return data.json();
							} else {
								console.log(new Error("네트워크 응답에 문제가 발생했습니다."));
							}
						}).then((res) => {
							const result = res.greetings.find((item) => {
								return item.userName === user;
							})

							if (result) {
								resolve({ name: result.userName, greetings: result.greetings });
							} else {
								throw new Error("no greetings message");
							}
						});
				})

			}
		}

		const userStorage = new UserStorage();

		const userName = prompt("이름을 입력하세요");
		const password = prompt("비밀번호를 입력하세요");

		try {
			(async function () {
				// await로 인해 Promise 객체가 아닌 값을 반환하기 떄문에
				// 변수에 저장하여 함수의 매개변수로 전달할 수 있다.
				const user = await userStorage.searchUser(userName, password);
				const result = await userStorage.sayHi(user);
				alert(`당신에게 인사합니다! ${result.name}님 ${result.greetings}`);
			}())
		} catch (error) {
			console.log(new Error(error));
		};

			// .then((result) => {
			// 	return userStorage.sayHi(result);
			// })
			// .then((result) => {
			// 	alert(`당신에게 인사합니다! ${result.name}님 ${result.greetings}`)
			// })
			// .catch((errorMsg) => {
			// 	console.log(new Error(errorMsg));
			// })
	</script>
</body>

</html>